<!DOCTYPE html>
<html lang="en">
  <head>
    <title>feathers-webpush example</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box
      }

      html {
        height: 100%
      }

      body {
        min-height: 100%;
        display: flex;
        align-items: center
      }

      #main {
        margin:4rem auto;
        text-align:center
      }

      .hide {
        display:none
      }

      button {
        border:1px solid #eaeaea;
        border-radius:5px;
        padding:5px;
        color:white
      }

      #btnSubscribe, #btnPush {
        background: green
      }

      #btnUnsubscribe {
        background: red
      }

      #isSubscribed {
        font-size:.8rem;
        margin-bottom: 1rem
      }
    </style>
  </head>

  <body>
    <main id="main">
      <h2>Welcome to feathers-webpush</h2>
      <div id="isSubscribed"></div>
      <button onclick="sendNotification()" id="btnPush" class="hide">Push</button>
      <button onclick="subscribe()" id="btnSubscribe" class="hide">Subscribe</button>
      <button onclick="unsubscribe()" id="btnUnsubscribe" class="hide">Unsubscribe</button>
    </main>
  </body>

  <script src="https://unpkg.com/@feathersjs/client@^5.0.0-pre.28/dist/feathers.js"></script>
  <script src="https://unpkg.com/socket.io-client@4.5.3/dist/socket.io.min.js"></script>
  <script type="module">
    import { checkPrerequisites, getPushSubscription, subscribePushNotifications, unsubscribePushNotifications, requestNotificationPermission } from '/feathers-webpush/client.js'

    // Vapid public key
    const publicVapidKey = '' 

    // Create the client Feathers app
    const app = feathers()
    // Configure the transport using socket.io
    const socket = io('http://localhost:3333')
    const transport = feathers.socketio(socket)
    app.configure(transport)

    // Functions
    async function registerServiceWorker () {
      // Check for serviceWorker on navigator
      if ('serviceWorker' in navigator) {
        try {
          await navigator.serviceWorker.register('/service-worker.js')
          console.log('Service worker successfully registered')
        } catch(err) {
          new Error('ServiceWorker registration failed: ', err)
        }
      }
    }
    async function isSubscribed () {
      // Check subscription to web push notifications
      const subscription = getPushSubscription()
      if (subscription) {
        // Check if the subscription is in database
        const subscriptionService = await app.service('users').find({ querry: { $select: ['endpoint', subscription.endpoint] }})
        if (subscriptionService.length === 0) {
          document.getElementById('isSubscribed').innerHTML = 'You must subscribe to receive notifications !'
          document.getElementById('btnSubscribe').className = ''
          document.getElementById('btnPush').className = 'hide'
          document.getElementById('btnUnsubscribe').className = 'hide'
        } else {
          console.log ( 'You are subscribed :' , subscription )
          document.getElementById('isSubscribed').innerHTML = 'You are subscribed !'
          document.getElementById('btnSubscribe').className = 'hide'
          document.getElementById('btnPush').className = ''
          document.getElementById('btnUnsubscribe').className = ''
        }
      } else {
        document.getElementById('isSubscribed').innerHTML = 'You must subscribe to receive notifications !'
        document.getElementById('btnSubscribe').className = ''
        document.getElementById('btnPush').className = 'hide'
        document.getElementById('btnUnsubscribe').className = 'hide'
      }
    }
    window.subscribe = async () => {
      // Subscribe to web webpush notifications
      let subscription = await subscribePushNotifications(publicVapidKey)
      // Create subscription
      app.service('users').create({
        subscriptions: [{
          endpoint: subscription.endpoint,
          keys: {
            auth: subscription.keys.auth,
            p256dh: subscription.keys.p256dh
          }
        }]
      })
      // Update page
      document.getElementById('isSubscribed').innerHTML = 'You are subscribed !'
      document.getElementById('btnSubscribe').className = 'hide'
      document.getElementById('btnPush').className = ''
      document.getElementById('btnUnsubscribe').className = ''
      console.log('Webpush subscription registered: ', subscription)
    }
    window.unsubscribe = async () => {
      // Unsubscribe from web webpush notifications
      const subscription = unsubscribePushNotifications()
      // Remove subscription
      app.service('users').remove(null, { query: { $select: ['endpoint', subscription.endpoint] }})
      // Update page
      document.getElementById('isSubscribed').innerHTML = 'You must subscribe to receive notifications !'
      document.getElementById('btnSubscribe').className = ''
      document.getElementById('btnPush').className = 'hide'
      document.getElementById('btnUnsubscribe').className = 'hide'
      console.log('Unsubscribing to web push notifications')
    }
    window.sendNotification = async () => {
      // Setup notification params
      const dataNotification = {
        title: 'feathers-webpush example title',
        body: 'feathers-webpush example body',
        icon: 'https://s3.eu-central-1.amazonaws.com/kalisioscope/kalisio/kalisio-icon-256x256.png',
        url: 'https://kalisio.com/'
      }
      // Send webpush notification
      app.service('push').create({
        dataNotification: dataNotification, 
        subscriptionService: 'users',
        subscriptionProperties: 'subscriptions'
      })
    }

    // Immediate
    if (checkPrerequisites()) console.log('All prerequisites are valid')
    requestNotificationPermission()
    registerServiceWorker()
    isSubscribed()
  </script>
</html>